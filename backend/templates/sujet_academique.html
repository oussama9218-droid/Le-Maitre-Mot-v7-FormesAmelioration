<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ document.type_doc|title }} — {{ document.matiere }} {{ document.niveau }}</title>
  <!-- Import base CSS for themes -->
  <link rel="stylesheet" href="base.css">
  
  <style>
    @page {
      size: A4;
      margin: 2cm 2cm 2cm 2cm;
      @bottom-center {
        content: "Page " counter(page) " / " counter(pages);
        font-size: 9pt;
        color: #444;
      }
    }

    body { font-family: "Times New Roman", serif; font-size: 11pt; line-height: 1.4; color: #000; }

    .header { display:grid; grid-template-columns:1fr 2fr; gap:10px; align-items:center; padding-bottom:12px; margin-bottom:16px; border-bottom:1px solid #000; }
    .logo img { max-height:70px; max-width:120px; }
    .school { text-align:right; font-size:10pt; }
    .school .school-name { font-weight:700; }

    .title { text-align:center; font-size:16pt; font-weight:700; margin:10px 0; text-transform:uppercase; }
    .subtitle { text-align:center; font-size:12pt; margin:4px 0; }

    .student-line { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; padding:8px 12px; margin:8px 0 20px 0; border:1px solid #000; font-size:10pt; }
    .field { display:flex; gap:6px; align-items:center; }
    .field label { min-width:55px; }
    .field .line { flex:1; border-bottom:1px dotted #000; height:16px; }

    .exercise { 
      margin:0 0 20px 0; 
      page-break-inside:avoid; 
      border: 1px solid #ddd; 
      padding: 15px; 
      background: #fefefe;
    }
    .exercise-header { 
      font-weight:700; 
      margin-bottom:12px; 
      border-bottom:1px solid #000; 
      padding-bottom:4px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    .points { font-size:10pt; font-style:italic; }
    .exercise-content { 
      display: flex; 
      gap: 20px; 
      align-items: start; 
    }
    .exercise-left { 
      flex: 1; 
      min-width: 0; 
    }
    .exercise-right { 
      width: 250px; 
      flex-shrink: 0;
    }
    .exercise-text { text-align:justify; }
    .exercise-schema { 
      border:1px solid #ccc; 
      background:#fafafa; 
      padding:8px; 
      text-align:center; 
      max-width:250px; 
    }
    .exercise-schema svg { 
      max-width: 100%; 
      height: auto; 
    }

    .answer-space { border:1px solid #000; background:#fff; margin-top:8px; }
    .answer-lines { height:3cm; background-image:repeating-linear-gradient(transparent, transparent 0.7cm, #000 0.7cm, #000 0.72cm); }

    .sep { height:1px; background:#000; margin:16px 0; opacity:.3; }

    .footer { position:fixed; bottom:0; left:0; right:0; height:30px; display:flex; align-items:center; justify-content:space-between; font-size:9pt; color:#444; border-top:1px solid #000; padding:0 1.5cm; }
    .footer-left { flex:1; }
    .footer-center { flex:1; text-align:center; }
    .footer-right { flex:1; text-align:right; font-weight:700; }

    /* QCM styling */
    .qcm-options {
      margin: 10px 0;
      padding-left: 0;
      list-style: none;
    }
    
    .qcm-options li {
      margin: 6px 0;
      padding: 4px 0;
      display: flex;
      align-items: center;
    }
    
    .qcm-options li::before {
      content: "☐";
      margin-right: 8px;
      font-size: 12pt;
    }
    /* Removed old geometric-schema style - replaced by exercise-schema */

  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      {% if template_config and template_config.logo_url %}
        <img src="{{ template_config.logo_url }}" alt="Logo" />
      {% endif %}
    </div>
    <div class="school">
      {% if template_config and template_config.school_name %}<div class="school-name">{{ template_config.school_name }}</div>{% endif %}
      {% if template_config and template_config.professor_name %}<div>{{ template_config.professor_name }}</div>{% endif %}
      {% if template_config and template_config.school_year %}<div>{{ template_config.school_year }}</div>{% endif %}
    </div>
  </div>

  <div class="title">
    {% if document.type_doc == 'controle' %}Contrôle{% elif document.type_doc == 'dm' %}Devoir Maison{% else %}Exercices{% endif %}
  </div>
  <div class="subtitle">{{ document.matiere }} — {{ document.niveau }} — {{ document.chapitre }}</div>

  <div class="student-line">
    <div class="field"><label>Nom :</label><div class="line"></div></div>
    <div class="field"><label>Prénom :</label><div class="line"></div></div>
    <div class="field"><label>Classe :</label><div class="line"></div></div>
    {% if document.type_doc == 'controle' %}
      <div class="field"><label>Note :</label><div class="line"></div></div>
    {% elif document.type_doc == 'dm' %}
      <div class="field"><label>Date rendu :</label><div class="line"></div></div>
    {% else %}
      <div class="field"><label>Date :</label><div class="line"></div></div>
    {% endif %}
  </div>

  {% for exercise in document.exercises or [] %}
  <div class="exercise">
    <div class="exercise-header">
      <span>Exercice {{ loop.index }}</span>
      <span class="points">
        {% set total_points = (exercise.bareme or [])|sum(attribute='points') %} 
        ({{ "%.1f"|format(total_points) }} pts)
      </span>
    </div>
    
    <div class="exercise-content">
      <div class="exercise-left">
        <div class="exercise-text">{{ exercise.enonce or '' }}</div>
        
        {% if exercise.type == 'qcm' and exercise.donnees and exercise.donnees.options %}
          <ul class="qcm-options">
            {% for option in exercise.donnees.options %}
              <li>{{ option }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      
      <div class="exercise-right">
        {% if exercise.schema_svg %}
          <div class="exercise-schema schema--{{ document.template_style|default('academique') }}">
            {{ exercise.schema_svg|safe }}
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="answer-space"><div class="answer-lines"></div></div>
  </div>
  {% if not loop.last %}<div class="sep"></div>{% endif %}
  {% endfor %}

  <div class="footer">
    <div class="footer-left">{% if template_config and template_config.footer_text %}{{ template_config.footer_text }}{% endif %}</div>
    <div class="footer-center">{% if template_config and template_config.school_year %}{{ template_config.school_year }}{% endif %}</div>
    <div class="footer-right">Académie</div>
  </div>
</body>
</html>