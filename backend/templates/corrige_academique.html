<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Corrigé — {{ document.type_doc|title }} — {{ document.matiere }} {{ document.niveau }}</title>
  <!-- Import base CSS for themes -->
  <link rel="stylesheet" href="base.css">
  
  <style>
    @page {
      size: A4;
      margin: 2cm 2cm 2cm 2cm;
      @bottom-center {
        content: "Page " counter(page) " / " counter(pages);
        font-size: 9pt;
        color: #444;
      }
    }

    body { font-family: "Times New Roman", serif; font-size: 11pt; line-height: 1.4; color: #000; }

    .header { display:grid; grid-template-columns:1fr 2fr; gap:10px; align-items:center; padding-bottom:12px; margin-bottom:16px; border-bottom:1px solid #000; }
    .logo img { max-height:70px; max-width:120px; }
    .school { text-align:right; font-size:10pt; }
    .school .school-name { font-weight:700; }

    .title { text-align:center; font-size:16pt; font-weight:700; margin:10px 0; text-transform:uppercase; }
    .subtitle { text-align:center; font-size:12pt; margin:4px 0; }

    .exercise { margin:0 0 20px 0; page-break-inside:avoid; }
    .exercise-header { font-weight:700; margin-bottom:6px; border-bottom:1px solid #000; padding-bottom:2px; }
    .points { font-size:10pt; font-style:italic; float:right; }
    .exercise-text { text-align:justify; margin:8px 0; font-style:italic; }

    .solution { border:1px solid #000; padding:8px 10px; margin-top:8px; }
    .solution-title { font-weight:700; margin-bottom:6px; }
    .step { margin-bottom:4px; padding-left:8px; }
    .final-result { border-top:1px solid #000; padding-top:6px; margin-top:6px; font-weight:700; }

    .bareme { margin-top:10px; padding:6px 10px; border:1px dashed #000; font-size:10pt; }
    .bareme-title { font-weight:700; margin-bottom:4px; }
    .bareme-item { margin-bottom:2px; }

    .sep { height:1px; background:#000; margin:16px 0; opacity:.3; }

    .footer { position:fixed; bottom:0; left:0; right:0; height:30px; display:flex; align-items:center; justify-content:space-between; font-size:9pt; color:#444; border-top:1px solid #000; padding:0 1.5cm; }
    .footer-left { flex:1; }
    .footer-center { flex:1; text-align:center; }
    .footer-right { flex:1; text-align:right; font-weight:700; }

    /* QCM styling */
    .qcm-options {
      margin: 10px 0;
      padding-left: 0;
      list-style: none;
    }
    
    .qcm-options li {
      margin: 6px 0;
      padding: 4px 0;
      display: flex;
      align-items: center;
    }
    
    .qcm-options li::before {
      content: "☐";
      margin-right: 8px;
      font-size: 12pt;
    }
        /* NEW: Style for geometric schemas */
        .geometric-schema {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #333;
            background-color: #fafafa;
            border-radius: 8px;
        }
        
        .geometric-schema svg {
            max-width: 100%;
            height: auto;
        }

  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      {% if template_config and template_config.logo_url %}
        <img src="{{ template_config.logo_url }}" alt="Logo" />
      {% endif %}
    </div>
    <div class="school">
      {% if template_config and template_config.school_name %}<div class="school-name">{{ template_config.school_name }}</div>{% endif %}
      {% if template_config and template_config.professor_name %}<div>{{ template_config.professor_name }}</div>{% endif %}
      {% if template_config and template_config.school_year %}<div>{{ template_config.school_year }}</div>{% endif %}
    </div>
  </div>

  <div class="title">
    Corrigé — {% if document.type_doc == 'controle' %}Contrôle{% elif document.type_doc == 'dm' %}Devoir Maison{% else %}Exercices{% endif %}
  </div>
  <div class="subtitle">{{ document.matiere }} — {{ document.niveau }} — {{ document.chapitre }}</div>

  {% for exercise in document.exercises or [] %}
  <div class="exercise">
    <div class="exercise-header">
      Exercice {{ loop.index }} 
      <span class="points">
        {% set total_points = (exercise.bareme or [])|sum(attribute='points') %} 
        ({{ "%.1f"|format(total_points) }} pts)
      </span>
    </div>
    <div class="exercise-text">{{ exercise.enonce or '' }}</div>
    
    <!-- NEW: Render geometric schema SVG if generated -->
    {% if exercise.schema_svg %}
        <div class="exercise-schema schema--{{ document.template_style|default('academique') }}">
            {{ exercise.schema_svg|safe }}
        </div>
    {% endif %}
    
    {% if exercise.type == 'qcm' and exercise.donnees and exercise.donnees.options %}
      <ul class="qcm-options">
        {% for option in exercise.donnees.options %}
          <li>{{ option }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    
    <div class="solution">
      <div class="solution-title">Solution :</div>
      {% if exercise.solution and exercise.solution.etapes %}
        {% for etape in exercise.solution.etapes %}
          <div class="step">{{ loop.index }}. {{ etape }}</div>
        {% endfor %}
      {% endif %}
      {% if exercise.solution and exercise.solution.resultat %}
        <div class="final-result">Résultat final : {{ exercise.solution.resultat }}</div>
      {% endif %}
    </div>
    
    {% if exercise.bareme %}
      <div class="bareme">
        <div class="bareme-title">Barème :</div>
        {% for item in exercise.bareme %}
          <div class="bareme-item">• {{ item.etape }} : {{ item.points }} pt(s)</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  {% if not loop.last %}<div class="sep"></div>{% endif %}
  {% endfor %}

  <div class="footer">
    <div class="footer-left">{% if template_config and template_config.footer_text %}{{ template_config.footer_text }}{% endif %}</div>
    <div class="footer-center">{% if template_config and template_config.school_year %}{{ template_config.school_year }}{% endif %}</div>
    <div class="footer-right">Académie</div>
  </div>
</body>
</html>